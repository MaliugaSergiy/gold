<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>Document</title>

	<link rel="stylesheet" href="remodal/remodal.css">
	<link rel="stylesheet" href="remodal/remodal-default-theme.css">
	<link rel="stylesheet" href="nice-select.css">
	<link rel="stylesheet" href="pop-up.css">
	<link rel="stylesheet" href="deliv.css">
</head>

<body>
	<a data-remodal-target="modal" href="#">Call pop-up</a>
	<div class="remodal remodal-credit" data-remodal-id="modal">
		<button data-remodal-action="close" class="remodal-close"></button>
		<div class="credit_header">
			<div class="wr">
				<div class="roww name">Выберите условия для кредитования</div>
				<div class="roww under_name">Кредит оформляется на безналичную стоимость товара - <span id="mainPrice">7 987</span> грн.</div>
			</div>
		</div>
		<div class="credit_content">
			<div class="wr">
				<form action="" class="item_cr">
					<div class="colll colll1">
						<div class="call_name">Оплата частями</div>
						<div class="call_under_name"></div>
					</div>
					<div class="colll colll2">
						<div class="select_wrapper ">
							<select name="" id="select_option1" class="select_option nice_select">
								<option value="3">3 мес.</option>
								<option value="6">6 мес.</option>
								<option value="9">9 мес.</option>
								<option selected value="12">12 мес.</option>
								<option  value="15">15 мес.</option>
								<option value="18">18 мес.</option>
								<option value="21">21 мес.</option>
								<option value="24">24 мес.</option>
							</select>
						</div>
						<input id="range1" class="select_range" type="range" min="3" max="24" step="3" value="12" data-orientation="vertical">
						<div class="range_marker start_range">3 мес.</div>
						<div class="range_marker end_range">24 мес.</div>
					</div>
					<div class="colll colll3 price">
						<p><span id="partPrice1" class="partPrice">1 238</span> грн/мес</p>
					</div>
					<div class="colll colll4">
						<button type="submit" data-remodal-action="confirm" class="cr_btn">купить</button>
					</div>
				</form>

				<form action="" class="item_cr">
					<div class="colll colll1">
						<div class="call_name">МГНОВЕННАЯ РАССРОЧКА</div>
						<div class="call_under_name">комиссия банка - <span id="bankComission">2,9</span>% </div>
					</div>
					<div class="colll colll2">
						<div class="select_wrapper">
							<select name="" id="select_option2" class="select_option nice_select">
								<option value="3">3 мес.</option>
								<option selected="selected" value="6">6 мес.</option>
								<option value="9">9 мес.</option>
								<option  value="12">12 мес.</option>
								<option  value="15">15 мес.</option>
								<option value="18">18 мес.</option>
								<option value="21">21 мес.</option>
								<option value="24">24 мес.</option>
							</select>
						</div>
						<input id="range2" class="select_range" type="range" min="3" max="24" step="3" value="6" data-orientation="vertical">
						<div class="range_marker start_range">3 мес.</div>
						<div class="range_marker end_range">24 мес.</div>
					</div>
					<div class="colll colll3 price">
						<p><span id="partPrice2" class="partPrice">903</span> грн/мес</p>
					</div>
					<div class="colll colll4">
						<button type="submit" data-remodal-action="confirm" class="cr_btn">купить</button>
					</div>
				</form>
			</div>
		</div>

		<div class="credit_footer">
			<div class="wr">
				<p>Для оформления кредита необходимо нажать кнопку “Купить”, перейти к оформлению заказа, либо продолжить покупки и добавить дополнительный товар в “Корзину”, заполнить анкету и отправить на рассмотрение. После этого с Вами свяжется сотрудник для уточнения данных.</p>
			</div>
		</div>
	</div>

	<div class="wrrr">
		<div class="content_delivery">
			<input id="month_del" value="18" type="text">
			<input id="credit_persent" value="2.9" type="text">
			<div class="colll coll1">
				<div class="select_wrapper ">
					<select name="" id="select_option3" class="select_option nice_select">
						<option value="3">3 мес.</option>
						<option value="6">6 мес.</option>
						<option value="9">9 мес.</option>
						<option selected value="12">12 мес.</option>
						<option  value="15">15 мес.</option>
						<option value="18">18 мес.</option>
						<option value="21">21 мес.</option>
						<option value="24">24 мес.</option>
					</select>
				</div>
				<input id="range3" class="select_range" type="range" min="3" max="24" step="3" value="12" data-orientation="vertical">
				<div class="range_marker start_range">3 мес.</div>
				<div class="range_marker end_range">24 мес.</div>
			</div>
			<div class="colll coll2">
				<p><span id="partPrice3" class="partPrice">903</span> грн/мес</p>
			</div>
		</div>
	</div>

	<script src="remodal/jquery-3.2.1.min.js"></script>
	<script src="remodal/remodal.js"></script>
	<script src="jquery.nice-select.min.js"></script>

	<script>
		


	</script>
	<script>
		$(".nice_select").niceSelect();



		function ready() {


			var calculated_credit_price = +(document.getElementById("mainPrice").innerText.split(" ").join("")),
				credit_persent = +(document.getElementById("credit_persent").value.split(" ").join("")),
				calculatedPersebtPrice = calculated_credit_price + calculated_credit_price * credit_persent / 100;
			
			//start values
			document.getElementById("range3").value = document.getElementById("month_del").value;
			document.getElementById("select_option3").value = document.getElementById("month_del").value;
			document.querySelectorAll("span#partPrice3")[0].innerHTML = (Math.ceil(calculatedPersebtPrice *100/ document.getElementById("month_del").value)/100).toFixed(2);

			// handler on range change
			document.getElementById("range3").addEventListener("input", function() {
				actionByChangingRanre(this);
				document.getElementById("partPrice3").innerHTML = (Math.round(calculatedPersebtPrice / this.value) );
			});
			
			// handler on select changes
			document.querySelectorAll("select.select_option")[1].addEventListener("change", function() {
				var dataValue = this.value;
				this.closest(".colll").querySelectorAll("input#range3")[0].value = this.value;
				//this.parentNode.parentNode.children[1].value = this.value;
				this.closest(".colll").querySelectorAll("span#partPrice3")[0].innerHTML = (Math.round(calculatedPersebtPrice / dataValue) );
				//this.parentNode.parentNode.parentNode.children[2].children[0].children[0].innerHTML = Math.ceil((mainPrice / 24) * dataValue);
			});


			//___________________________ ACTIONS BY DROPP-DOWN MENU CHANGES
			document.querySelectorAll(".content_delivery")[0].addEventListener("click", function(e) {
				
				
				var target = e.target,
					formTag = target.closest(".content_delivery"),
					bankComissionTag = formTag.querySelectorAll("#bankComission")[0],
					partPriceTag = formTag.querySelectorAll("span.partPrice")[0];
					
				if (target.tagName != "LI") return;
					console.log(formTag);
				var dataValue = target.getAttribute("data-value"),
					setRange = target.closest(".colll").querySelectorAll("input.select_range")[0];
				setRange.value = dataValue;

					partPriceTag.innerText = (Math.ceil(calculatedPersebtPrice * 100 / dataValue) / 100).toFixed(2);

			});








			//$("body").append('<div class="remodal content_delivery">');

			var mainPrice = +(document.getElementById("mainPrice").innerText.split(" ").join("")),
				bankComission = document.getElementById("bankComission").innerText.split(",").join("."),
				calculatedPrice = mainPrice + mainPrice * bankComission / 100;

			// set start value of part prices
			//document.getElementById("partPrice1").innerHTML = (Math.ceil(mainPrice * 100 / document.getElementById("select_option1").value) / 100).toFixed(2);
			document.getElementById("partPrice1").innerHTML = (Math.round(mainPrice  / document.getElementById("select_option1").value) );
			document.getElementById("partPrice2").innerHTML = (Math.round(calculatedPrice  / document.getElementById("select_option2").value) );


			//___________________________ ACTIONS BY INPUT-RANGE CHANGES 
			document.getElementById("range1").addEventListener("input", function() {
				actionByChangingRanre(this);
				document.getElementById("partPrice1").innerHTML = (Math.round(mainPrice / this.value));
			});
			document.getElementById("range2").addEventListener("input", function() {
				actionByChangingRanre(this);
				document.getElementById("partPrice2").innerHTML = (Math.round(calculatedPrice / this.value));
			});

			function actionByChangingRanre(this1) {
				var //текущее значение (value) range
					curentRange = this1.value,
					// заголовок дроппДаун меню
					//curentVal = this1.parentNode.children[0].children[1].children[0], //
					curentVal = this1.closest(".colll").querySelectorAll("span.current")[0], //
					// select node 
					//selectNode = this1.parentNode.children[0].children[0],
					selectNode = this1.closest(".colll").querySelectorAll("select.select_option")[0],
					// select массив
					selectArr = selectNode.children,
					selectOptions = selectNode.options,
					// значение option select'a который соответствует текущему значению input range
					newCurentVal,
					// массив ul дроппДаун меню
					//arrUl = this1.parentNode.children[0].children[1].children[1].children; //
					arrUl = this1.closest(".colll").querySelectorAll("li.option");

				for (var i = 0; i < selectOptions.length; i++) {

					if (selectArr[i].value == this1.value) {
						newCurentVal = selectOptions[i].innerHTML;
						curentVal.innerHTML = newCurentVal;
						selectNode.value = curentRange;
						//selectArr[i].setAttribute("selected");
					};
					if (arrUl[i].getAttribute("data-value") == this1.value) {
						for (var j = 0; j < arrUl.length; j++) {
							arrUl[j].classList.remove("selected");
						}
						arrUl[i].classList.add("selected");
					}
				}
			}

			//___________________________ ACTIONS BY SELECT CHANGES
			document.querySelectorAll("select.select_option")[0].addEventListener("change", function() {
				var dataValue = this.value;
				this.closest(".colll").querySelectorAll("input#range1")[0].value = this.value;
				//this.parentNode.parentNode.children[1].value = this.value;
				this.closest("form").querySelectorAll("span#partPrice1")[0].innerHTML = (Math.round(mainPrice / dataValue) );
				//this.parentNode.parentNode.parentNode.children[2].children[0].children[0].innerHTML = Math.ceil((mainPrice / 24) * dataValue);
			});

			document.querySelectorAll("select.select_option")[1].addEventListener("change", function() {
				var dataValue = this.value;
				this.closest(".colll").querySelectorAll("input#range2")[0].value = this.value;
				this.closest("form").querySelectorAll("span#partPrice2")[0].innerHTML = (Math.round(calculatedPrice / dataValue) );
			});

			//___________________________ ACTIONS BY DROPP-DOWN MENU CHANGES
			document.querySelectorAll(".credit_content")[0].addEventListener("click", function(e) {
				var target = e.target,
					formTag = target.closest("form"),
					bankComissionTag = formTag.querySelectorAll("#bankComission")[0],
					partPriceTag = formTag.querySelectorAll("span.partPrice")[0];

				if (target.tagName != "LI") return;

				var dataValue = target.getAttribute("data-value"),
					setRange = target.closest(".colll").querySelectorAll("input.select_range")[0];
				setRange.value = dataValue;
				if (bankComissionTag) {
					partPriceTag.innerText = (Math.round(calculatedPrice / dataValue) );
				} else {
					partPriceTag.innerText = (Math.round(mainPrice / dataValue) );
				}
			});

			// при загрузке cтраницы, а так же при ресайзинге по ширине, запускаем проверку на браузер и ширину экрана
			function defineDeviceAndSize() {
				$(".nice-select").removeClass("open");
				if (/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) && window.innerWidth < 750) {
					$('.nice_select').niceSelect('destroy');
					$('.content_delivery .select_wrapper').addClass('only_mob');
				} else {
					if ($(".nice_select")) {
						$('select').niceSelect();
						$('.content_delivery .select_wrapper').removeClass('only_mob');
					}
				}
			}
			defineDeviceAndSize();

			window.addEventListener('resize', function(event) {
				defineDeviceAndSize();
			});
		}
		document.addEventListener("DOMContentLoaded", ready);




		//___________________________ ACTIONS BY DROPP-DOWN MENU CHANGES
		//        var optionCollection = document.getElementsByClassName("option");
		//        for (var i = 0; i < optionCollection.length; i++) {
		//            optionCollection[i].addEventListener("click", function() {
		//                var dataValue = this.getAttribute("data-value"),
		//                    //setRange = this.parentNode.parentNode.parentNode.parentNode.children[1];
		//                    setRange = this.closest(".colll").querySelectorAll("input.select_range")[0];
		//                setRange.value = dataValue;
		//
		//                //if (this.parentNode.parentNode.parentNode.parentNode.parentNode.children[0].children[1].children[0]) {
		//                if (this.closest("form").querySelectorAll("#bankComission")[0]) {
		//                    //this.parentNode.parentNode.parentNode.parentNode.parentNode.children[2].children[0].children[0].innerText = Math.ceil((calculatedPrice / 24) * dataValue);
		//                    this.closest("form").querySelectorAll("span.partPrice")[0].innerText = Math.ceil((calculatedPrice / 24) * dataValue);
		//                } else {
		//                    //this.parentNode.parentNode.parentNode.parentNode.parentNode.children[2].children[0].children[0].innerText = Math.ceil((mainPrice / 24) * dataValue);
		//                    this.closest("form").querySelectorAll("span.partPrice")[0].innerText = Math.ceil((mainPrice / 24) * dataValue);
		//                }
		//
		//            });
		//        }

	</script>
</body>

</html>
